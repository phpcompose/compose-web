<?php
$this->layout = 'admin::layout';
/** @var array<int,array<string,mixed>> $entries */
?>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="h5 mb-1">Contact Entries</h1>
                <div class="text-muted">Most recent submissions.</div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Form</th>
                        <th scope="col">Email</th>
                        <th scope="col">Subject</th>
                        <th scope="col">Tags</th>
                        <th scope="col">Flags</th>
                        <th scope="col">Created</th>
                        <th scope="col">Details</th>
                    </tr>
                </thead>
                <tbody>
                <?php foreach ($entries as $entry): ?>
                    <tr>
                        <td><?= (int) $entry['id'] ?></td>
                        <td><span class="badge bg-secondary"><?= htmlspecialchars($entry['form_slug'], ENT_QUOTES, 'UTF-8') ?></span></td>
                        <td><?= htmlspecialchars($entry['email'] ?? '-', ENT_QUOTES, 'UTF-8') ?></td>
                        <td><?= htmlspecialchars($entry['subject'] ?? '-', ENT_QUOTES, 'UTF-8') ?></td>
                        <td>
                            <?php $tags = $entry['tags'] ?? []; ?>
                            <?php if ($tags === []): ?>
                                <span class="text-muted small">none</span>
                            <?php else: ?>
                                <?php foreach ($tags as $tag): ?>
                                    <span class="badge bg-light text-dark border me-1"><?= htmlspecialchars($tag, ENT_QUOTES, 'UTF-8') ?></span>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </td>
                        <td class="text-nowrap">
                            <?php $isRead = !empty($entry['is_read']); ?>
                            <?php $isStar = !empty($entry['is_starred']); ?>
                            <a class="btn btn-sm <?= $isStar ? 'btn-warning' : 'btn-outline-secondary' ?>" href="/admin/contact/list/<?= $isStar ? 'unstar' : 'star' ?>/<?= (int) $entry['id'] ?>" title="<?= $isStar ? 'Unstar' : 'Star' ?>">
                                <i class="bi <?= $isStar ? 'bi-star-fill' : 'bi-star' ?>"></i>
                            </a>
                            <a class="btn btn-sm <?= $isRead ? 'btn-success' : 'btn-outline-secondary' ?>" href="/admin/contact/list/<?= $isRead ? 'unread' : 'read' ?>/<?= (int) $entry['id'] ?>" title="<?= $isRead ? 'Mark unread' : 'Mark read' ?>">
                                <i class="bi <?= $isRead ? 'bi-envelope-open' : 'bi-envelope' ?>"></i>
                            </a>
                        </td>
                        <td><?= htmlspecialchars($entry['created_at'] ?? '', ENT_QUOTES, 'UTF-8') ?></td>
                        <td>
                            <details>
                                <summary class="small text-muted">View payload</summary>
                                <pre class="mb-0 bg-light p-2 border rounded small"><?=
                                    htmlspecialchars(json_encode($entry['payload'] ?? [], JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE), ENT_QUOTES, 'UTF-8')
                                ?></pre>
                            </details>
                        </td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>
